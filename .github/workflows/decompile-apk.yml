name: Decompile APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  decompile:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repository
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Setup Java
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '17'

    # 3Ô∏è‚É£ Install basic dependencies
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip wget

    # 4Ô∏è‚É£ Install apktool (correct way)
    - name: Install apktool
      run: |
        wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
        wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
        chmod +x apktool
        sudo mv apktool /usr/local/bin/apktool
        sudo mv apktool_2.9.3.jar /usr/local/bin/apktool.jar

    # 5Ô∏è‚É£ Install dex2jar (WORKING VERSION)
    - name: Install dex2jar
      run: |
        wget https://github.com/pxb1988/dex2jar/releases/download/v2.3/dex2jar-2.3.zip
        unzip dex2jar-2.3.zip
        sudo mv dex2jar-2.3 /opt/dex2jar
        sudo chmod +x /opt/dex2jar/*.sh
        echo "/opt/dex2jar" >> $GITHUB_PATH

    # 6Ô∏è‚É£ Install CFR
    - name: Install CFR
      run: |
        wget https://www.benf.org/other/cfr/cfr-0.152.jar -O cfr.jar

    # 7Ô∏è‚É£ Download APK
    - name: Download APK
      run: |
        mkdir -p ks-craft
        wget https://files.apkdlink.com/minecraft/minecraft-minecraft-apk-latest-october.apk \
        -O ks-craft/minecraft.apk

    # 8Ô∏è‚É£ Decompile resources with apktool
    - name: Decompile resources (apktool)
      run: |
        mkdir -p ks-craft/decompiled
        apktool d ks-craft/minecraft.apk \
        -o ks-craft/decompiled/resources -f

    # 9Ô∏è‚É£ Convert DEX to JAR
    - name: Convert DEX to JAR
      run: |
        d2j-dex2jar.sh ks-craft/minecraft.apk \
        -o ks-craft/decompiled/minecraft.jar

    # üîü Decompile Java source using CFR
    - name: Decompile Java source (CFR)
      run: |
        mkdir -p ks-craft/decompiled/source
        java -jar cfr.jar ks-craft/decompiled/minecraft.jar \
        --outputdir ks-craft/decompiled/source

    # 1Ô∏è‚É£1Ô∏è‚É£ Upload artifacts
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: decompiled-files
        path: ks-craft/
